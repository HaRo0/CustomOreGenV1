package net.kaupenjoe.hytale.oregenv1.loader.generator;

import com.google.gson.JsonObject;
import com.hypixel.hytale.math.vector.Vector2i;
import com.hypixel.hytale.procedurallib.json.SeedString;
import com.hypixel.hytale.server.worldgen.SeedStringResource;
import com.hypixel.hytale.server.worldgen.WorldGenConfig;
import com.hypixel.hytale.server.worldgen.chunk.ChunkGenerator;
import com.hypixel.hytale.server.worldgen.chunk.MaskProvider;
import com.hypixel.hytale.server.worldgen.loader.ChunkGeneratorJsonLoader;
import com.hypixel.hytale.server.worldgen.loader.context.FileContextLoader;
import com.hypixel.hytale.server.worldgen.loader.context.FileLoadingContext;
import com.hypixel.hytale.server.worldgen.loader.zone.ZonePatternProviderJsonLoader;
import com.hypixel.hytale.server.worldgen.prefab.PrefabStoreRoot;
import com.hypixel.hytale.server.worldgen.zone.Zone;
import net.kaupenjoe.hytale.oregenv1.loader.zone.ModZonesJsonLoader;

import javax.annotation.Nonnull;
import java.nio.file.Files;
import java.nio.file.LinkOption;
import java.nio.file.Path;

public class ModChunkGeneratorJsonLoader extends ChunkGeneratorJsonLoader {

    private final WorldGenConfig config;


    public ModChunkGeneratorJsonLoader(SeedString<SeedStringResource> seed, WorldGenConfig config) {

        super(seed,config);
        this.config = config;
    }

    @Override
    @Nonnull
    public ChunkGenerator load() {

        Path worldFile = this.dataFolder.resolve("World.json").toAbsolutePath();
        if (!Files.exists(worldFile)) {
            throw new IllegalArgumentException(String.valueOf(worldFile));
        } else if (!Files.isReadable(worldFile)) {
            throw new IllegalArgumentException(String.valueOf(worldFile));
        } else {
            JsonObject worldJson = this.loadWorldJson(worldFile);
            Path overrideDataFolder = this.loadOverrideDataFolderPath(worldJson, config.path());
            WorldGenConfig config = this.config.withOverride(overrideDataFolder);

            Vector2i worldSize = this.loadWorldSize(worldJson);
            Vector2i worldOffset = this.loadWorldOffset(worldJson);
            MaskProvider maskProvider = this.loadMaskProvider(worldJson, worldSize, worldOffset);
            PrefabStoreRoot prefabStore = this.loadPrefabStore(worldJson);
            this.seed.get().setPrefabConfig(config,prefabStore);

            ZonePatternProviderJsonLoader loader = this.loadZonePatternGenerator(maskProvider);
            FileLoadingContext loadingContext = new FileContextLoader(overrideDataFolder, loader.loadZoneRequirement()).load();
            Zone[] zones = new ModZonesJsonLoader(this.seed, overrideDataFolder, loadingContext).load();
            loader.setZones(zones);
            return new ChunkGenerator(loader.load(), overrideDataFolder);
        }
    }

    @Nonnull
    private Path loadOverrideDataFolderPath(@Nonnull JsonObject worldJson, @Nonnull Path dataFolder) {
        if (worldJson.has("OverrideDataFolder")) {
            Path overrideFolder = dataFolder.resolve(worldJson.get("OverrideDataFolder").getAsString()).normalize();
            Path parent = dataFolder.getParent();
            if (overrideFolder.startsWith(parent) && Files.exists(overrideFolder, new LinkOption[0])) {
                return overrideFolder;
            } else {
                throw new Error(String.format("Override folder '%s' must exist within: '%s'", overrideFolder.getFileName(), parent));
            }
        } else {
            return dataFolder;
        }
    }
}
